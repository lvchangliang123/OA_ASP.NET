@using Newtonsoft.Json;
@model BlogModels.ViewModels.BlogContentViewModel
@Html.AntiForgeryToken()
@{
     ViewBag.Title = "查看博客";
}
<!--这里只做显示，不可编辑-->
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/Emoji/dist/emojionearea.min.css" />
    <link rel="stylesheet" href="~/MarkDown/css/editormd.min.css" />
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/Emoji/dist/emojionearea.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
    <!--引入editormd文件-->
    <script src="~/MarkDown/src/editormd.js"></script>
    <script src="~/MarkDown/lib/marked.min.js"></script>
    <script src="~/MarkDown/lib/prettify.min.js"></script>
    <script src="~/MarkDown/lib/raphael.min.js"></script>
    <script src="~/MarkDown/lib/underscore.min.js"></script>
    <script src="~/MarkDown/lib/sequence-diagram.min.js"></script>
    <script src="~/MarkDown/lib/flowchart.min.js"></script>
    <script src="~/MarkDown/lib/jquery.flowchart.min.js"></script>

</head>

<body>

    <div class="card">
        <div class="card-header">
            <div class="box" style="display:flex;justify-content:center">
                <span class="box-shadow" style="vertical-align:middle;font-weight:600;font-family:Helvetica;font-size:18pt">@Model.BlogTitle</span>
            </div>
        </div>

        <div class="card-body" id="editor" style="width:90%;height:800px">
            <textarea>@Model.BlogContent</textarea>
        </div>

        <div class="card-footer" style="display:flex;justify-content:left">
            <div>
                <span style="display:inline-block;height:30px;line-height:30px">文章标签:</span>
            </div>
            <ul class="list-unstyled list-inline" style="margin-left:10px">
                @foreach (var tag in Model.BlogTagList)
                {
                    <li class="list-inline-item" style="justify-content:center;align-items:center">
                        <!--块元素的文字居中:height:30px;line-height:30px-->
                        <span style="color:white;background-color:#31a6a0;border-radius:3px;display:inline-block;vertical-align:middle;height:30px;line-height:30px;padding-left:10px;padding-right:10px">
                            @tag.ToString()
                        </span>
                    </li>
                }
            </ul>
        </div>
    </div>

    <!--文章底部放置评论功能模块-->

    <div class="card">
        <div>
            <span style="font-family:Helvetica;font-weight:bold;margin-left:15px;margin-top:10px">发表评论</span>
        </div>
        <div>
            <form id="commentForm" class="form-control">
                <input id="inputBlogId" type="text" value="@Model.BlogId" style="display:none" />
                <textarea id="emojiText" rows="5" style="width:100%">@Model.NewBlogComment.CommentBody</textarea>
                <div class="input-group" style="width:50%">
                    <span class="input-group-text">昵称</span>
                    <input id="inputUserName" type="text" class="form-control" placeholder="User Name" value="@Model.NewBlogComment.CommentUserName"/>
                </div>
                <div class="input-group" style="width:50%;margin-top:10px">
                    <span class="input-group-text">邮箱</span>
                    <input id="inputEmail" type="email" class="form-control" placeholder="User Email" value="@Model.NewBlogComment.CommentUserEmail"/>
                </div>
                <input type="button" class="btn btn-primary" onclick="SubCommentAjax();" style="width:15%;margin-top:10px" value="提交"/>
            </form>
        </div>
    </div>

    <div style="margin-top:10px">
        <div style="background-color:blanchedalmond;height:40px;border-radius:5px;border:none">
            <span style="vertical-align:middle;line-height:40px;margin-left:10px;font-weight:800">评论列表</span>
        </div>
        @foreach (var comment in Model.BlogComments)
        {
            <div id="commentContainer" style="margin:5px;border-bottom:dashed;border-width:thin">
                <div id="commentUserAvatar" style="display:inline-block;vertical-align:top">
                    <img src="~/UserAvatars/@comment.CommentUserAvatar" style="object-fit:cover;border:solid;border-color:#e6e6e6;border-radius:30px;width:60px;height:60px" />
                </div>
                <div style="display:inline-block">
                    <div id="userNameWithComment" style="vertical-align:top;line-height:30px">
                        <span>@comment.CommentUserName.ToString(): @comment.CommentBody</span>
                    </div>
                    <div id="commentDate" style="vertical-align:bottom;line-height:30px">
                        <span style="color:darkgray">@comment.CommentDate</span>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="divPage">
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item" id="preBtn">
                    <a class="page-link" href="#">上一页</a>
                </li>
                <li class="page-item" id="nextBtn">
                    <a class="page-link" href="#">下一页</a>
                </li>
                <li>
                    <div class="alert alert-light" role="alert" id="text">

                    </div>
                </li>
            </ul>
        </nav>
    </div>

    <script type="text/javascript">
        var pageNumber = 1;
        var pageSize = 5;
        var last;

        //var initdata = function(commentList){

        //}

        //改变页码的函数
        //var change = function(){
        //    $("#text").text("");
        //    var str = '当前第'+pageNumber+'页,'+'共'+last+'页';
        //    $("#text").text(str);
        //}

        //上一页，下一页的点击函数

        //1.ajax请求获取数据
        //var check = function(){
        //    $.get("http://localhost:8080/find",{"pageNumber":pageNumber,"pageSize":pageSize},function(data){
        //        //每次点击，刷新comments的数据源即可
        //    },"json");
        //}
        //2.上一页
        //$("#preBtn a").click(function(){
        //    if(pageNumber>1){
        //        pageNumber = pageNumber-1;
        //        check();
        //        change();
        //    }
        //});
        //3.下一页
        //$("#nextBtn a").click(function(){
        //    if(pageNumber<last){
        //        pageNumber = pageNumber+1;
        //        check();
        //        change();
        //    }
        //});
        //4.初始化数据的函数(ajax)
        $(function(){
            GetBlogComment();
        })

        function GetBlogComment(){
            $.ajax({
                type: "POST",
                url: "/UserBlog/GetBlogCommentByBlogId",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "pageNumber": pageNumber,
                    "pageSize": pageSize,
                    "BlogId": @Model.BlogId,
                }),
                success: function (response) {
                    //last = response.Count;
                    alert(response[0].CommentDate);
                    //var commentListResult = JSON.parse(response);
                    //alert(commentListResult.Count.ToString());
                    //alert(commentListResult.ToString());
                    //initdata(response);
                    //change();
                },
                failure: function (response) {
                    alert("Failed to Get Blog Comment!");
                }
            });
        }
        //https://www.cnblogs.com/moonblogcore/p/11659892.html

        //https://blog.csdn.net/hailongcsdn/article/details/106298517

    </script>

    <script type="text/javascript">
        $(function(){
            //初始化富文本编辑器
            var editor = editormd.markdownToHTML("editor", {
                htmlDecode: "style, script, iframe",
                emoji: true,
                taskList: true,
                tex: true,  // 默认不解析
                flowChart: true,  // 默认不解析
                sequenceDiagram: true,  // 默认不解析
                syncScrolling: "single",
                pickerPosition: "bottom",
                path: "~/MarkDown/lib/",  // Autoload modules mode, codemirror, marked... dependents libs path
            });
        });
    </script>

    <!--点击提交评论的ajax请求-->
    <script type="text/javascript">
        function SubCommentAjax() {
            $.ajax({
                type: "POST",
                url: "/UserBlog/SubmitBlogComment",
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify({
                    "Blogid": $("#inputBlogId").val(),
                    "Commentbody": $("#emojiText").val(),
                    "Commentusername": $("#inputUserName").val(),
                    "Commentuseremail": $("#inputEmail").val(),
                }),
                success: function (response) {
                    alert("Success:"+response);
                },
                failure: function (response) {
                    alert("Failed:"+response);
                }
            });
        }
    </script>

</body>

